import streamlit as st
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.multioutput import MultiOutputRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_percentage_error
import os

# -------------------- CONFIG --------------------
st.set_page_config(page_title="Smart Layout AI", page_icon="ðŸŽ—ï¸", layout="centered")

# -------------------- LOAD DATA --------------------
data_path = "data update (2).xlsx"
if not os.path.exists(data_path):
    st.error("à¹„à¸¡à¹ˆà¸žà¸šà¹„à¸Ÿà¸¥à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ 'data update (2).xlsx'")
    st.stop()

# Load dataset
st.markdown("## ðŸ“Š à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³à¸‚à¸­à¸‡à¹‚à¸¡à¹€à¸”à¸¥")
df = pd.read_excel(data_path)
df.columns = df.columns.str.strip()
df.fillna(0, inplace=True)

# Feature Engineering
df['à¸«à¸¥à¸±à¸‡à¸•à¹ˆà¸­à¸‹à¸­à¸¢'] = df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'] / df['à¸ˆà¸³à¸™à¸§à¸™à¸‹à¸­à¸¢'].replace(0, 1)
df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™'] = df.get('à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™'] = df.get('à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸šà¹‰à¸²à¸™à¹à¸à¸”'] = df.get('à¸šà¹‰à¸²à¸™à¹à¸à¸”', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸—à¸²à¸§à¹‚à¸®à¸¡'] = df.get('à¸—à¸²à¸§à¹‚à¸®à¸¡', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸‚à¸²à¸¢'] = df.get('à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢(à¸•à¸£à¸¡)', 0) / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)']
df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'] = df.get('à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²(à¸•à¸£à¸¡)', 0) / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)']

# à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™ / à¸ªà¸²à¸˜à¸²à¸£à¸“à¸°
if 'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™à¸£à¸§à¸¡(à¸•à¸£.à¸¡.)' in df.columns and 'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²(à¸•à¸£à¸¡)' in df.columns:
    à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² = df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™à¸£à¸§à¸¡(à¸•à¸£.à¸¡.)'] / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²(à¸•à¸£à¸¡)'].replace(0, 1)
    à¹€à¸‰à¸¥à¸µà¹ˆà¸¢_à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² = à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸²[(à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² > 0) & (à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² < 5)].mean()
else:
    à¹€à¸‰à¸¥à¸µà¹ˆà¸¢_à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² = 0.65

df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™'] = df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'] * à¹€à¸‰à¸¥à¸µà¹ˆà¸¢_à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸²

# Model inputs
X_raw = df[['à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”', 'à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£', 'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)', 'à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™']]
y_ratio = pd.DataFrame({
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²': df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢': df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸‚à¸²à¸¢'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸™': df.get('à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸™(5%à¸‚à¸­à¸‡à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢)', 0) / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)'],
    'à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡à¸•à¹ˆà¸­à¹„à¸£à¹ˆ': df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'] / (df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)'] / 1600),
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸—à¸²à¸§à¹‚à¸®à¸¡': df['%à¸—à¸²à¸§à¹‚à¸®à¸¡'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹à¸à¸”': df['%à¸šà¹‰à¸²à¸™à¹à¸à¸”'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™': df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™': df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™': df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™']
})

# Encoding
X = pd.get_dummies(X_raw, columns=['à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”', 'à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£', 'à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™'])
X_train, X_test, y_train, y_test = train_test_split(X, y_ratio.fillna(0), test_size=0.2, random_state=42)

# Train model
model = MultiOutputRegressor(RandomForestRegressor(n_estimators=100, random_state=42))
model.fit(X_train, y_train)
y_pred = model.predict(X_test)

# Evaluate accuracy
accuracy_table = pd.DataFrame(columns=['à¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ', 'Accuracy (%)'])
for i, col in enumerate(y_ratio.columns):
    mape = mean_absolute_percentage_error(y_test.iloc[:, i], y_pred[:, i])
    acc = 100 - (mape * 100)
    accuracy_table.loc[len(accuracy_table)] = [col, round(acc, 2)]

# Show table
st.dataframe(accuracy_table, use_container_width=True)
st.caption("*à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³à¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸ˆà¸£à¸´à¸‡à¸—à¸µà¹ˆà¸–à¸·à¸­à¹€à¸›à¹‡à¸™ Best Practice 100%")
