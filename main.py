import streamlit as st
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.multioutput import MultiOutputRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_percentage_error
import os

# -------------------- CONFIG --------------------
st.set_page_config(page_title="Smart Layout AI", page_icon="ðŸŽ—ï¸", layout="centered")

# -------------------- LOAD DATA --------------------
data_path = "data update (2).xlsx"
if not os.path.exists(data_path):
    st.error("à¹„à¸¡à¹ˆà¸žà¸šà¹„à¸Ÿà¸¥à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ 'data update (2).xlsx'")
    st.stop()

# Load dataset
st.markdown("## ðŸ“Š à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³à¸‚à¸­à¸‡à¹‚à¸¡à¹€à¸”à¸¥")
df = pd.read_excel(data_path)
df.columns = df.columns.str.strip()
df.fillna(0, inplace=True)

# Feature Engineering
df['à¸«à¸¥à¸±à¸‡à¸•à¹ˆà¸­à¸‹à¸­à¸¢'] = df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'] / df['à¸ˆà¸³à¸™à¸§à¸™à¸‹à¸­à¸¢'].replace(0, 1)
df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™'] = df.get('à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™'] = df.get('à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸šà¹‰à¸²à¸™à¹à¸à¸”'] = df.get('à¸šà¹‰à¸²à¸™à¹à¸à¸”', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸—à¸²à¸§à¹‚à¸®à¸¡'] = df.get('à¸—à¸²à¸§à¹‚à¸®à¸¡', 0) / df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'].replace(0, 1)
df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸‚à¸²à¸¢'] = df.get('à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢(à¸•à¸£à¸¡)', 0) / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)']
df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'] = df.get('à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²(à¸•à¸£à¸¡)', 0) / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)']

# à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™ / à¸ªà¸²à¸˜à¸²à¸£à¸“à¸°
if 'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™à¸£à¸§à¸¡(à¸•à¸£.à¸¡.)' in df.columns and 'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²(à¸•à¸£à¸¡)' in df.columns:
    à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² = df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™à¸£à¸§à¸¡(à¸•à¸£.à¸¡.)'] / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²(à¸•à¸£à¸¡)'].replace(0, 1)
    à¹€à¸‰à¸¥à¸µà¹ˆà¸¢_à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² = à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸²[(à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² > 0) & (à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² < 5)].mean()
else:
    à¹€à¸‰à¸¥à¸µà¹ˆà¸¢_à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸² = 0.65

df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™'] = df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'] * à¹€à¸‰à¸¥à¸µà¹ˆà¸¢_à¸–à¸™à¸™_à¸•à¹ˆà¸­_à¸ªà¸²à¸˜à¸²

# Model inputs
X_raw = df[['à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”', 'à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£', 'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)', 'à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™']]
y_ratio = pd.DataFrame({
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²': df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢': df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸‚à¸²à¸¢'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸™': df.get('à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸™(5%à¸‚à¸­à¸‡à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢)', 0) / df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)'],
    'à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡à¸•à¹ˆà¸­à¹„à¸£à¹ˆ': df['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡'] / (df['à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)'] / 1600),
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸—à¸²à¸§à¹‚à¸®à¸¡': df['%à¸—à¸²à¸§à¹‚à¸®à¸¡'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹à¸à¸”': df['%à¸šà¹‰à¸²à¸™à¹à¸à¸”'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™': df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™': df['%à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™'],
    'à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™': df['%à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™']
})

# Encoding
X = pd.get_dummies(X_raw, columns=['à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”', 'à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£', 'à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™'])
X_train, X_test, y_train, y_test = train_test_split(X, y_ratio.fillna(0), test_size=0.2, random_state=42)

# Train model
model = MultiOutputRegressor(RandomForestRegressor(n_estimators=100, random_state=42))
model.fit(X_train, y_train)
y_pred = model.predict(X_test)

# Evaluate accuracy
accuracy_table = pd.DataFrame(columns=['à¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ', 'Accuracy (%)'])

for i, col in enumerate(y_ratio.columns):
    y_true = y_test.iloc[:, i]
    y_pred_col = y_pred[:, i]

    mask = y_true != 0
    if mask.sum() == 0:
        acc = None
    else:
        mape = mean_absolute_percentage_error(y_true[mask], y_pred_col[mask])
        acc = 100 - (mape * 100)

    accuracy_table.loc[len(accuracy_table)] = [col, round(acc, 2) if acc is not None else "N/A"]

st.dataframe(accuracy_table, use_container_width=True)
st.caption("*à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³à¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸ˆà¸£à¸´à¸‡à¸—à¸µà¹ˆà¸–à¸·à¸­à¹€à¸›à¹‡à¸™ Best Practice 100%")

# -------------------- USER INPUT FOR PREDICTION --------------------
st.markdown("---")
st.markdown("## âœï¸ à¸žà¸¢à¸²à¸à¸£à¸“à¹Œà¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡à¸„à¸¸à¸“")

col1, col2 = st.columns(2)
à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”_input = col1.selectbox("à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”", sorted(df['à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”'].unique()))
à¹€à¸à¸£à¸”_input = col1.selectbox("à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£", sorted(df['à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£'].unique()))
à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡_input = col2.selectbox("à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™", sorted(df['à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™'].unique()))
à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input = col2.number_input("à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£ (à¸•à¸£à¸¡)", min_value=1, value=10000)

if st.button("ðŸ” à¸žà¸¢à¸²à¸à¸£à¸“à¹Œà¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ"):
    input_df = pd.DataFrame.from_dict({
        'à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”': [à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”_input],
        'à¹€à¸à¸£à¸”à¹‚à¸„à¸£à¸‡à¸à¸²à¸£': [à¹€à¸à¸£à¸”_input],
        'à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹‚à¸„à¸£à¸‡à¸à¸²à¸£(à¸•à¸£à¸¡)': [à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input],
        'à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™': [à¸£à¸¹à¸›à¸£à¹ˆà¸²à¸‡_input]
    })
    input_encoded = pd.get_dummies(input_df)

    for col in X.columns:
        if col not in input_encoded.columns:
            input_encoded[col] = 0
    input_encoded = input_encoded[X.columns]

    y_out = model.predict(input_encoded)[0]
    results = pd.Series(y_out, index=y_ratio.columns)

    # à¸„à¸³à¸™à¸§à¸“à¸„à¹ˆà¸²à¸ˆà¸²à¸à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸ˆà¸£à¸´à¸‡
    à¸žà¸—_à¸ªà¸²à¸˜à¸² = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²'] * à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input / 4, 0)
    à¸žà¸—_à¸‚à¸²à¸¢ = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢'] * à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input / 4, 0)
    à¸žà¸—_à¸ªà¸§à¸™ = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸™'] * à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input / 4, 0)
    à¸žà¸—_à¸–à¸™à¸™ = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™'] * à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input / 4, 0)
    à¸ˆà¸³à¸™à¸§à¸™_à¸«à¸¥à¸±à¸‡ = round(results['à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡à¸•à¹ˆà¸­à¹„à¸£à¹ˆ'] * (à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆ_input / 1600), 0)

    st.markdown("### âœ… à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸—à¸µà¹ˆà¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œ (à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹à¸¥à¸°à¸ˆà¸³à¸™à¸§à¸™à¹à¸›à¸¥à¸‡)")
    output_summary = pd.DataFrame({
        "à¸žà¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ": ["à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸˜à¸²à¸£à¸“à¸°", "à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ˆà¸³à¸«à¸™à¹ˆà¸²à¸¢", "à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸™", "à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸–à¸™à¸™", "à¸ˆà¸³à¸™à¸§à¸™à¹à¸›à¸¥à¸‡"],
        "à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œà¹„à¸”à¹‰": [f"{à¸žà¸—_à¸ªà¸²à¸˜à¸²:,} à¸•à¸£à¸§.", f"{à¸žà¸—_à¸‚à¸²à¸¢:,} à¸•à¸£à¸§.", f"{à¸žà¸—_à¸ªà¸§à¸™:,} à¸•à¸£à¸§.", f"{à¸žà¸—_à¸–à¸™à¸™:,} à¸•à¸£à¸§.", f"{int(à¸ˆà¸³à¸™à¸§à¸™_à¸«à¸¥à¸±à¸‡):,} à¸«à¸¥à¸±à¸‡"]
    })
    st.dataframe(output_summary, use_container_width=True)

    # à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸«à¸¥à¸±à¸‡à¹à¸¢à¸à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—
    th_units = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸—à¸²à¸§à¹‚à¸®à¸¡'] * à¸ˆà¸³à¸™à¸§à¸™_à¸«à¸¥à¸±à¸‡)
    twin_units = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹à¸à¸”'] * à¸ˆà¸³à¸™à¸§à¸™_à¸«à¸¥à¸±à¸‡)
    sd2_units = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§2à¸Šà¸±à¹‰à¸™'] * à¸ˆà¸³à¸™à¸§à¸™_à¸«à¸¥à¸±à¸‡)
    sd3_units = round(results['à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§3à¸Šà¸±à¹‰à¸™'] * à¸ˆà¸³à¸™à¸§à¸™_à¸«à¸¥à¸±à¸‡)

    st.markdown("### ðŸ¡ à¹à¸¢à¸à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸šà¹‰à¸²à¸™")
    st.markdown(f"- à¸—à¸²à¸§à¸™à¹Œà¹‚à¸®à¸¡: **{th_units:,} à¸«à¸¥à¸±à¸‡**")
    st.markdown(f"- à¸šà¹‰à¸²à¸™à¹à¸à¸”: **{twin_units:,} à¸«à¸¥à¸±à¸‡**")
    st.markdown(f"- à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§ 2 à¸Šà¸±à¹‰à¸™: **{sd2_units:,} à¸«à¸¥à¸±à¸‡**")
    st.markdown(f"- à¸šà¹‰à¸²à¸™à¹€à¸”à¸µà¹ˆà¸¢à¸§ 3 à¸Šà¸±à¹‰à¸™: **{sd3_units:,} à¸«à¸¥à¸±à¸‡**")

    st.markdown("### ðŸ“ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ % à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³à¸ˆà¸²à¸à¹‚à¸¡à¹€à¸”à¸¥")
    st.dataframe(accuracy_table, use_container_width=True)
    st.caption("*à¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸šà¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸„à¸²à¸”à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Best Practice")
